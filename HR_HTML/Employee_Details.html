<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCMS - Employee Details</title>
    <link rel="stylesheet" href="../CSS/Manage.css">
    <link rel="stylesheet" href="../CSS/sidebar.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
</head>
<body>
    <div id="sidebar-placeholder"></div>
    <div class="main-content">
        <div class="employee-details-container">
            <div class="section-title">
                EMPLOYEE DETAILS
                <button onclick="goBack()" class="action-btn cancel-btn" style="float: right;">BACK TO LIST</button>
            </div>
            
            <div class="profile-container">
                <div class="section-title">PERSONAL INFORMATION</div>
                <div class="profile-details" id="employee-details">
                    <!-- Employee details will be loaded here -->
                </div>
                <div class="form-actions">
                    <button id="edit-btn" class="action-btn edit-btn">EDIT EMPLOYEE</button>
                    <button id="delete-btn" class="action-btn delete-btn">DELETE EMPLOYEE</button>
                </div>
            </div>

            <div class="profile-container">
                <div class="section-title">LEAVE CREDIT BALANCE</div>
                <table id="leave-balance-table">
                    <thead>
                        <tr>
                            <th>TITLE</th>
                            <th>TOTAL DAYS</th>
                            <th>USED</th>
                            <th>REMAINING</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Leave balance will be loaded here -->
                    </tbody>
                </table>
                <div class="form-actions" style="margin-top: 15px;">
                    <button id="edit-leave-credits-btn" class="action-btn edit-btn">EDIT LEAVE CREDITS</button>
                </div>
            </div>

            <div class="profile-container">
                <div class="section-title">LEAVE TRANSACTION HISTORY</div>
                <table id="leave-history-table">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>TYPE OF LEAVE</th>
                            <th>FROM</th>
                            <th>TO</th>
                            <th>TOTAL DAYS</th>
                            <th>STATUS</th>
                            <th>REASON/NOTES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Leave history will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div id="edit-employee-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeEditModal()" style="float:right;cursor:pointer;">&times;</span>
                <div class="profile-container">
                    <div class="section-title">EDIT EMPLOYEE</div>
                    <form id="edit-employee-form">
                        <input type="hidden" id="edit-emp-id">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Full Name:</label>
                                <input type="text" id="edit-emp-name" required>
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="edit-emp-email" required readonly>
                            </div>
                            <div class="form-group">
                                <label>Gender:</label>
                                <select id="edit-emp-gender" required>
                                    <option value="MALE">MALE</option>
                                    <option value="FEMALE">FEMALE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Phone Number:</label>
                                <input type="text" id="edit-emp-phone" required>
                            </div>
                            <div class="form-group">
                                <label>Home Address:</label>
                                <input type="text" id="edit-emp-address" required>
                            </div>
                            <div class="form-group">
                                <label>Department:</label>
                                <input type="text" id="edit-emp-department" required>
                            </div>
                            <div class="form-group">
                                <label>Designation:</label>
                                <input type="text" id="edit-emp-designation" required>
                            </div>
                            <div class="form-group">
                                <label>Role:</label>
                                <select id="edit-emp-role" required>
                                    <option value="employee">Employee</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="hr">HR</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="action-btn save-btn">UPDATE EMPLOYEE</button>
                            <button type="button" class="action-btn cancel-btn" onclick="closeEditModal()">CANCEL</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Leave Credits Modal -->
        <div id="edit-leave-credits-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeLeaveCreditsModal()" style="float:right;cursor:pointer;">&times;</span>
                <div class="profile-container">
                    <div class="section-title">EDIT LEAVE CREDITS</div>
                    <form id="edit-leave-credits-form">
                        <div class="leave-credits-grid">
                            <div class="leave-credit-item">
                                <label>Regular Leave:</label>
                                <input type="number" id="edit-regular-leave" min="0" max="30" placeholder="15">
                                <small>Days per year</small>
                            </div>
                            <div class="leave-credit-item">
                                <label>Sick Leave:</label>
                                <input type="number" id="edit-sick-leave" min="0" max="30" placeholder="10">
                                <small>Days per year</small>
                            </div>
                            <div class="leave-credit-item">
                                <label>Emergency Leave:</label>
                                <input type="number" id="edit-emergency-leave" min="0" max="15" placeholder="5">
                                <small>Days per year</small>
                            </div>
                            <div class="leave-credit-item">
                                <label>Maternity/Paternity Leave:</label>
                                <input type="number" id="edit-maternity-leave" min="0" max="120" placeholder="60">
                                <small>Days per year</small>
                            </div>
                            <div class="leave-credit-item">
                                <label>Service Incentive Leave:</label>
                                <input type="number" id="edit-service-leave" min="0" max="10" placeholder="5">
                                <small>Days per year</small>
                            </div>
                            <div class="leave-credit-item">
                                <label>Special Privilege Leave:</label>
                                <input type="number" id="edit-special-leave" min="0" max="10" placeholder="3">
                                <small>Days per year</small>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="action-btn save-btn">UPDATE LEAVE CREDITS</button>
                            <button type="button" class="action-btn cancel-btn" onclick="closeLeaveCreditsModal()">CANCEL</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts -->
    <script src="../js/firebase-init.js"></script>
    <script src="../js/auth-utils.js"></script>
    <script src="../components/sidebar-loader.js"></script>
    
    <script>
        let currentEmployeeId = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuthAndRole('hr');
            
            // Load sidebar
            loadSidebar('hr');
            
            // Get employee ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentEmployeeId = urlParams.get('id');
            
            if (currentEmployeeId) {
                loadEmployeeDetails();
            } else {
                alert('No employee ID provided');
                goBack();
            }
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('edit-btn').addEventListener('click', openEditModal);
            document.getElementById('delete-btn').addEventListener('click', handleDeleteEmployee);
            document.getElementById('edit-employee-form').addEventListener('submit', handleEditEmployee);
            document.getElementById('edit-leave-credits-btn').addEventListener('click', openLeaveCreditsModal);
            document.getElementById('edit-leave-credits-form').addEventListener('submit', handleEditLeaveCredits);
        }
        
        // Load employee details
        function loadEmployeeDetails() {
            db.collection('employees').doc(currentEmployeeId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const employee = doc.data();
                        displayEmployeeDetails(employee);
                        loadLeaveBalance(currentEmployeeId, employee);
                        loadLeaveHistory(currentEmployeeId);
                    } else {
                        alert('Employee not found');
                        goBack();
                    }
                })
                .catch((error) => {
                    console.error("Error loading employee:", error);
                    alert('Error loading employee details');
                    goBack();
                });
        }
        
        // Display employee details
        function displayEmployeeDetails(employee) {
            const detailsContainer = document.getElementById('employee-details');
            detailsContainer.innerHTML = `
                <div class="detail-item">NAME: ${employee.name}</div>
                <div class="detail-item">EMAIL: ${employee.email}</div>
                <div class="detail-item">GENDER: ${employee.gender}</div>
                <div class="detail-item">PHONE NUMBER: ${employee.phone}</div>
                <div class="detail-item">HOME ADDRESS: ${employee.address}</div>
                <div class="detail-item">DEPARTMENT: ${employee.department}</div>
                <div class="detail-item">DESIGNATION: ${employee.designation}</div>
                <div class="detail-item">ROLE: ${employee.role.toUpperCase()}</div>
                <div class="detail-item">CREATED: ${employee.createdAt ? new Date(employee.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                <div class="detail-item">LAST UPDATED: ${employee.updatedAt ? new Date(employee.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
            `;
        }
        
        // Load leave balance from employee data
        function loadLeaveBalance(employeeId, employee) {
            const tableBody = document.querySelector('#leave-balance-table tbody');
            
            // Check if employee has leave credits stored
            if (employee.leaveCredits) {
                const leaveCredits = employee.leaveCredits;
                let leaveRows = '';
                
                // Convert leave credits object to array and display
                Object.values(leaveCredits).forEach(leave => {
                    leaveRows += `<tr>
                        <td>${leave.title}</td>
                        <td>${leave.days}</td>
                        <td>${leave.used}</td>
                        <td>${leave.remaining}</td>
                    </tr>`;
                });
                
                tableBody.innerHTML = leaveRows;
            } else {
                // Default leave balance for employees created before leave credits feature
                const defaultLeave = [
                    {title: "Regular Leave", days: 15, used: 0, remaining: 15},
                    {title: "Sick Leave", days: 10, used: 0, remaining: 10},
                    {title: "Emergency Leave", days: 5, used: 0, remaining: 5},
                    {title: "Maternity/Paternity Leave", days: 60, used: 0, remaining: 60},
                    {title: "Service Incentive Leave", days: 5, used: 0, remaining: 5},
                    {title: "Special Privilege Leave", days: 3, used: 0, remaining: 3}
                ];
                
                const leaveRows = defaultLeave.map(l => `<tr>
                    <td>${l.title}</td>
                    <td>${l.days}</td>
                    <td>${l.used}</td>
                    <td>${l.remaining}</td>
                </tr>`).join('');
                
                tableBody.innerHTML = leaveRows;
            }
        }
        
        // Load leave history (empty for now)
        function loadLeaveHistory(employeeId) {
            const tableBody = document.querySelector('#leave-history-table tbody');
            
            // In a real app, this would query leave requests from Firestore
            tableBody.innerHTML = '<tr><td colspan="7">No leave history found</td></tr>';
        }
        
        // Open edit modal
        function openEditModal() {
            db.collection('employees').doc(currentEmployeeId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const employee = doc.data();
                        
                        // Fill edit form
                        document.getElementById('edit-emp-id').value = currentEmployeeId;
                        document.getElementById('edit-emp-name').value = employee.name;
                        document.getElementById('edit-emp-email').value = employee.email;
                        document.getElementById('edit-emp-gender').value = employee.gender;
                        document.getElementById('edit-emp-phone').value = employee.phone;
                        document.getElementById('edit-emp-address').value = employee.address;
                        document.getElementById('edit-emp-department').value = employee.department;
                        document.getElementById('edit-emp-designation').value = employee.designation;
                        document.getElementById('edit-emp-role').value = employee.role;
                        
                        // Show edit modal
                        document.getElementById('edit-employee-modal').style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error("Error getting employee data:", error);
                    alert('Error loading employee data');
                });
        }
        
        // Handle edit employee form submission
        async function handleEditEmployee(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('edit-emp-id').value;
            const updatedData = {
                name: document.getElementById('edit-emp-name').value,
                gender: document.getElementById('edit-emp-gender').value,
                phone: document.getElementById('edit-emp-phone').value,
                address: document.getElementById('edit-emp-address').value,
                department: document.getElementById('edit-emp-department').value,
                designation: document.getElementById('edit-emp-designation').value,
                role: document.getElementById('edit-emp-role').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('employees').doc(employeeId).update(updatedData);
                alert('Employee updated successfully!');
                closeEditModal();
                loadEmployeeDetails(); // Reload the details
                
            } catch (error) {
                console.error("Error updating employee:", error);
                alert('Error updating employee: ' + error.message);
            }
        }
        
        // Handle delete employee
        function handleDeleteEmployee() {
            if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
                db.collection('employees').doc(currentEmployeeId).delete()
                    .then(() => {
                        alert('Employee deleted successfully!');
                        goBack();
                    })
                    .catch((error) => {
                        console.error("Error deleting employee:", error);
                        alert('Error deleting employee: ' + error.message);
                    });
            }
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-employee-modal').style.display = 'none';
        }
        
        // Open leave credits edit modal
        function openLeaveCreditsModal() {
            db.collection('employees').doc(currentEmployeeId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const employee = doc.data();
                        const leaveCredits = employee.leaveCredits;
                        
                        if (leaveCredits) {
                            // Fill the form with current values
                            document.getElementById('edit-regular-leave').value = leaveCredits.regularLeave?.days || 15;
                            document.getElementById('edit-sick-leave').value = leaveCredits.sickLeave?.days || 10;
                            document.getElementById('edit-emergency-leave').value = leaveCredits.emergencyLeave?.days || 5;
                            document.getElementById('edit-maternity-leave').value = leaveCredits.maternityLeave?.days || 60;
                            document.getElementById('edit-service-leave').value = leaveCredits.serviceLeave?.days || 5;
                            document.getElementById('edit-special-leave').value = leaveCredits.specialLeave?.days || 3;
                        } else {
                            // Set default values
                            document.getElementById('edit-regular-leave').value = 15;
                            document.getElementById('edit-sick-leave').value = 10;
                            document.getElementById('edit-emergency-leave').value = 5;
                            document.getElementById('edit-maternity-leave').value = 60;
                            document.getElementById('edit-service-leave').value = 5;
                            document.getElementById('edit-special-leave').value = 3;
                        }
                        
                        document.getElementById('edit-leave-credits-modal').style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error("Error getting employee data:", error);
                    alert('Error loading leave credits data');
                });
        }
        
        // Handle edit leave credits form submission
        async function handleEditLeaveCredits(e) {
            e.preventDefault();
            
            const updatedLeaveCredits = {
                regularLeave: {
                    title: "Regular Leave",
                    days: parseInt(document.getElementById('edit-regular-leave').value),
                    used: 0,
                    remaining: parseInt(document.getElementById('edit-regular-leave').value)
                },
                sickLeave: {
                    title: "Sick Leave",
                    days: parseInt(document.getElementById('edit-sick-leave').value),
                    used: 0,
                    remaining: parseInt(document.getElementById('edit-sick-leave').value)
                },
                emergencyLeave: {
                    title: "Emergency Leave",
                    days: parseInt(document.getElementById('edit-emergency-leave').value),
                    used: 0,
                    remaining: parseInt(document.getElementById('edit-emergency-leave').value)
                },
                maternityLeave: {
                    title: "Maternity/Paternity Leave",
                    days: parseInt(document.getElementById('edit-maternity-leave').value),
                    used: 0,
                    remaining: parseInt(document.getElementById('edit-maternity-leave').value)
                },
                serviceLeave: {
                    title: "Service Incentive Leave",
                    days: parseInt(document.getElementById('edit-service-leave').value),
                    used: 0,
                    remaining: parseInt(document.getElementById('edit-service-leave').value)
                },
                specialLeave: {
                    title: "Special Privilege Leave",
                    days: parseInt(document.getElementById('edit-special-leave').value),
                    used: 0,
                    remaining: parseInt(document.getElementById('edit-special-leave').value)
                }
            };
            
            try {
                await db.collection('employees').doc(currentEmployeeId).update({
                    leaveCredits: updatedLeaveCredits,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Leave credits updated successfully!');
                closeLeaveCreditsModal();
                loadEmployeeDetails(); // Reload the details
                
            } catch (error) {
                console.error("Error updating leave credits:", error);
                alert('Error updating leave credits: ' + error.message);
            }
        }
        
        // Close leave credits modal
        function closeLeaveCreditsModal() {
            document.getElementById('edit-leave-credits-modal').style.display = 'none';
        }
        
        // Go back to manage employees page
        function goBack() {
            window.location.href = 'Manage_Employee.html';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('edit-employee-modal');
            const leaveCreditsModal = document.getElementById('edit-leave-credits-modal');
            
            if (event.target == editModal) {
                closeEditModal();
            } else if (event.target == leaveCreditsModal) {
                closeLeaveCreditsModal();
            }
        };
    </script>
</body>
</html>
