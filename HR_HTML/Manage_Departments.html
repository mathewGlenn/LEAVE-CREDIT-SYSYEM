<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LCMS - Manage Departments</title>
    <link rel="stylesheet" href="../CSS/Manage.css" />
    <link rel="stylesheet" href="../CSS/sidebar.css" />

    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SweetAlert Custom CSS -->
    <link rel="stylesheet" href="../CSS/sweetalert-custom.css" />
    <!-- SweetAlert Utility Functions -->
    <script src="../js/sweetalert-utils.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  </head>
  <body>
    <div id="sidebar-placeholder"></div>
    <div class="main-content">
      <div class="employee-list-container">
        <div class="section-title">
          <span> DEPARTMENT LIST</span>
          <button id="add-department-btn" class="action-btn add-btn">
            ADD DEPARTMENT
          </button>
        </div>
        <table id="department-list">
          <thead>
            <tr>
              <th>Department Name</th>
              <th>Created Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="department-table-body">
            <!-- Departments will be loaded from Firestore -->
          </tbody>
        </table>
      </div>

      <!-- Add Department Modal -->
      <div id="add-department-modal" class="modal" style="display: none">
        <div class="modal-content">
          <span
            class="close-btn"
            onclick="closeAddModal()"
            style="float: right; cursor: pointer"
            >&times;</span
          >
          <div class="profile-container">
            <div class="section-title">ADD NEW DEPARTMENT</div>
            <form id="add-department-form">
              <div class="form-group">
                <label for="dept-name">Department Name:</label>
                <input
                  type="text"
                  id="dept-name"
                  name="dept-name"
                  required
                  placeholder="Enter department name"
                />
              </div>
              <div class="form-actions">
                <button type="submit" class="action-btn save-btn">
                  ADD DEPARTMENT
                </button>
                <button
                  type="button"
                  class="action-btn cancel-btn"
                  onclick="closeAddModal()"
                >
                  CANCEL
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Edit Department Modal -->
      <div id="edit-department-modal" class="modal" style="display: none">
        <div class="modal-content">
          <span
            class="close-btn"
            onclick="closeEditModal()"
            style="float: right; cursor: pointer"
            >&times;</span
          >
          <div class="profile-container">
            <div class="section-title">EDIT DEPARTMENT</div>
            <form id="edit-department-form">
              <input type="hidden" id="edit-dept-id" />
              <div class="form-group">
                <label for="edit-dept-name">Department Name:</label>
                <input
                  type="text"
                  id="edit-dept-name"
                  name="edit-dept-name"
                  required
                  placeholder="Enter department name"
                />
              </div>
              <div class="form-actions">
                <button type="submit" class="action-btn save-btn">
                  UPDATE DEPARTMENT
                </button>
                <button
                  type="button"
                  class="action-btn cancel-btn"
                  onclick="closeEditModal()"
                >
                  CANCEL
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Load scripts -->
    <script src="../js/firebase-init.js"></script>
    <script src="../js/auth-utils.js"></script>
    <script src="../components/sidebar-loader.js"></script>

    <script>
      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // Check authentication first
        checkAuthAndRole("hr");

        // Load sidebar
        loadSidebar("hr");

        // Load departments from Firestore
        loadDepartments();

        // Setup event listeners
        setupEventListeners();
      });

      // Setup event listeners
      function setupEventListeners() {
        // Add department button
        document
          .getElementById("add-department-btn")
          .addEventListener("click", function () {
            document.getElementById("add-department-modal").style.display =
              "block";
          });

        // Add department form submission
        document
          .getElementById("add-department-form")
          .addEventListener("submit", handleAddDepartment);

        // Edit department form submission
        document
          .getElementById("edit-department-form")
          .addEventListener("submit", handleEditDepartment);
      }

      // Load departments from Firestore
      function loadDepartments() {
        const tableBody = document.getElementById("department-table-body");
        tableBody.innerHTML =
          '<tr><td colspan="3">Loading departments...</td></tr>';

        db.collection("departments")
          .orderBy("name")
          .get()
          .then((querySnapshot) => {
            tableBody.innerHTML = "";

            if (querySnapshot.empty) {
              tableBody.innerHTML =
                '<tr><td colspan="3">No departments found</td></tr>';
              return;
            }

            querySnapshot.forEach((doc) => {
              const department = doc.data();
              const row = document.createElement("tr");
              row.className = "department-row";
              row.setAttribute("data-id", doc.id);

              const createdDate = department.createdAt
                ? new Date(department.createdAt.toDate()).toLocaleDateString()
                : "N/A";

              row.innerHTML = `
                <td>${department.name || "N/A"}</td>
                <td>${createdDate}</td>
                <td>
                  <button class="action-btn edit-btn" onclick="editDepartment('${
                    doc.id
                  }', '${department.name}')">Edit</button>
                  <button class="action-btn delete-btn" onclick="deleteDepartment('${
                    doc.id
                  }', '${department.name}')">Delete</button>
                </td>
              `;

              tableBody.appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Error loading departments:", error);
            tableBody.innerHTML =
              '<tr><td colspan="3">Error loading departments</td></tr>';
          });
      }

      // Handle add department form submission
      async function handleAddDepartment(e) {
        e.preventDefault();

        const formData = {
          name: document.getElementById("dept-name").value.trim(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        if (!formData.name) {
          showErrorAlert("Validation Error", "Please enter a department name");
          return;
        }

        try {
          showLoadingDialog(
            "Creating Department",
            "Please wait while we create the department..."
          );

          // Check if department already exists
          const existingDept = await db
            .collection("departments")
            .where("name", "==", formData.name)
            .get();

          if (!existingDept.empty) {
            closeDialog();
            showErrorAlert(
              "Duplicate Department",
              "Department with this name already exists!"
            );
            return;
          }

          // Save department data to Firestore
          await db.collection("departments").add(formData);

          closeDialog();
          showSuccessAlert(
            "Success",
            "Department created successfully!",
            () => {
              closeAddModal();
              loadDepartments(); // Reload the table
            }
          );
        } catch (error) {
          console.error("Error adding department:", error);
          closeDialog();
          showErrorAlert(
            "Error",
            "Error creating department: " + error.message
          );
        }
      }

      // Handle edit department
      function editDepartment(id, name) {
        document.getElementById("edit-dept-id").value = id;
        document.getElementById("edit-dept-name").value = name;
        document.getElementById("edit-department-modal").style.display =
          "block";
      }

      // Handle edit department form submission
      async function handleEditDepartment(e) {
        e.preventDefault();

        const deptId = document.getElementById("edit-dept-id").value;
        const newName = document.getElementById("edit-dept-name").value.trim();

        if (!newName) {
          showErrorAlert("Validation Error", "Please enter a department name");
          return;
        }

        try {
          showLoadingDialog(
            "Updating Department",
            "Please wait while we update the department..."
          );

          // Check if department name already exists (excluding current department)
          const existingDept = await db
            .collection("departments")
            .where("name", "==", newName)
            .get();

          if (!existingDept.empty && existingDept.docs[0].id !== deptId) {
            closeDialog();
            showErrorAlert(
              "Duplicate Department",
              "Department with this name already exists!"
            );
            return;
          }

          // Update department in Firestore
          await db.collection("departments").doc(deptId).update({
            name: newName,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          closeDialog();
          showSuccessAlert(
            "Success",
            "Department updated successfully!",
            () => {
              closeEditModal();
              loadDepartments(); // Reload the table
            }
          );
        } catch (error) {
          console.error("Error updating department:", error);
          closeDialog();
          showErrorAlert(
            "Error",
            "Error updating department: " + error.message
          );
        }
      }

      // Handle delete department
      async function deleteDepartment(id, name) {
        showDeleteConfirmation(name, async () => {
          try {
            showLoadingDialog(
              "Deleting Department",
              "Please wait while we delete the department..."
            );

            await db.collection("departments").doc(id).delete();

            closeDialog();
            showSuccessAlert(
              "Success",
              "Department deleted successfully!",
              () => {
                loadDepartments(); // Reload the table
              }
            );
          } catch (error) {
            console.error("Error deleting department:", error);
            closeDialog();
            showErrorAlert(
              "Error",
              "Error deleting department: " + error.message
            );
          }
        });
      }

      // Modal control functions
      function closeAddModal() {
        document.getElementById("add-department-modal").style.display = "none";
        document.getElementById("add-department-form").reset();
      }

      function closeEditModal() {
        document.getElementById("edit-department-modal").style.display = "none";
        document.getElementById("edit-department-form").reset();
      }

      // Close modals when clicking outside
      window.onclick = function (event) {
        const addModal = document.getElementById("add-department-modal");
        const editModal = document.getElementById("edit-department-modal");

        if (event.target == addModal) {
          closeAddModal();
        }
        if (event.target == editModal) {
          closeEditModal();
        }
      };
    </script>
  </body>
</html>
