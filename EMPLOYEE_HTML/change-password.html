<!DOCT    <link rel="stylesheet" href="../CSS/Employee.css">
<link rel="stylesheet" href="../CSS/sidebar.css" />
<link rel="stylesheet" href="../CSS/Req_leave.css" />E html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LCMS - Change Password</title>
    <link rel="stylesheet" href="../CSS/Employee.css" />
    <link rel="stylesheet" href="../CSS/sidebar.css" />

    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SweetAlert Custom CSS -->
    <link rel="stylesheet" href="../CSS/sweetalert-custom.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <!-- Firebase Initialization -->
    <script src="../js/firebase-init.js"></script>
    <script src="../js/auth-utils.js"></script>

    <!-- SweetAlert Utility Functions -->
    <script src="../js/sweetalert-utils.js"></script>

    <!-- Load sidebar script -->
    <script src="../components/sidebar-loader.js"></script>
    <script>
      // Call the loadSidebar function when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Check authentication first
        checkAuthAndRole("employee");

        // Load sidebar
        loadSidebar("employee");

        // Add form event listener
        document
          .getElementById("changePasswordForm")
          .addEventListener("submit", handlePasswordChange);
      });

      // Function to handle password change
      async function handlePasswordChange(event) {
        event.preventDefault();

        const currentPassword =
          document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const submitButton = document.getElementById("submitButton");
        const originalText = submitButton.textContent;

        try {
          // Validation
          if (!currentPassword || !newPassword || !confirmPassword) {
            showToast("error", "Please fill in all fields");
            return;
          }

          if (newPassword !== confirmPassword) {
            showToast("error", "New passwords do not match");
            return;
          }

          if (newPassword.length < 6) {
            showToast(
              "error",
              "New password must be at least 6 characters long"
            );
            return;
          }

          if (newPassword === currentPassword) {
            showToast(
              "error",
              "New password must be different from current password"
            );
            return;
          }

          // Show loading state
          submitButton.disabled = true;
          submitButton.innerHTML =
            '<div class="loading-spinner"></div>Changing Password...';

          const user = firebase.auth().currentUser;
          if (!user) {
            showToast("error", "User not authenticated");
            return;
          }

          // Create credential for re-authentication
          const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword
          );

          // Re-authenticate user
          await user.reauthenticateWithCredential(credential);

          // Update password
          await user.updatePassword(newPassword);

          showToast("success", "Password changed successfully!");

          // Clear form
          document.getElementById("changePasswordForm").reset();

          // Optionally redirect after a delay
          setTimeout(() => {
            window.location.href = "employee-profile-view.html";
          }, 2000);
        } catch (error) {
          console.error("Error changing password:", error);

          let errorMessage = "Failed to change password";

          // Handle specific Firebase auth errors
          switch (error.code) {
            case "auth/wrong-password":
              errorMessage = "Current password is incorrect";
              break;
            case "auth/weak-password":
              errorMessage = "New password is too weak";
              break;
            case "auth/requires-recent-login":
              errorMessage =
                "Please log out and log back in before changing your password";
              break;
            case "auth/too-many-requests":
              errorMessage = "Too many failed attempts. Please try again later";
              break;
            default:
              errorMessage = error.message || "Failed to change password";
          }

          showToast("error", errorMessage);
        } finally {
          // Reset button state
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }

      // Function to toggle password visibility
      function togglePasswordVisibility(inputId, toggleId) {
        const passwordInput = document.getElementById(inputId);
        const toggleIcon = document.getElementById(toggleId);

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          toggleIcon.textContent = "üôà";
        } else {
          passwordInput.type = "password";
          toggleIcon.textContent = "üëÅÔ∏è";
        }
      }
    </script>
  </head>
  <body>
    <!-- Sidebar placeholder that will be filled by the JavaScript -->
    <div id="sidebar-placeholder"></div>
    <div class="main-content">
      <!-- Back to Profile Button -->
      <div style="margin-bottom: 20px">
        <button
          onclick="window.location.href='employee-profile-view.html'"
          class="back-button"
        >
          ‚Üê Back to Profile
        </button>
      </div>

      <!-- Change Password Form -->
      <div class="password-change-container">
        <form id="changePasswordForm" class="leave-form">
          <div class="form-title">PASSWORD SECURITY</div>

          <div class="form-group">
            <label for="currentPassword">CURRENT PASSWORD</label>
            <div class="password-input-container">
              <input
                type="password"
                id="currentPassword"
                name="currentPassword"
                required
              />
              <button
                type="button"
                class="password-toggle"
                onclick="togglePasswordVisibility('currentPassword', 'toggleCurrent')"
              >
                <span id="toggleCurrent">üëÅÔ∏è</span>
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="newPassword">NEW PASSWORD</label>
            <div class="password-input-container">
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                required
                minlength="6"
              />
              <button
                type="button"
                class="password-toggle"
                onclick="togglePasswordVisibility('newPassword', 'toggleNew')"
              >
                <span id="toggleNew">üëÅÔ∏è</span>
              </button>
            </div>
            <div class="password-requirements">
              <small>Password must be at least 6 characters long</small>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">CONFIRM NEW PASSWORD</label>
            <div class="password-input-container">
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                minlength="6"
              />
              <button
                type="button"
                class="password-toggle"
                onclick="togglePasswordVisibility('confirmPassword', 'toggleConfirm')"
              >
                <span id="toggleConfirm">üëÅÔ∏è</span>
              </button>
            </div>
          </div>

          <button type="submit" class="submit-btn" id="submitButton">
            CHANGE PASSWORD
          </button>
        </form>
      </div>
    </div>

    <style>
      .back-button {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .back-button:hover {
        background-color: #5a6268;
      }

      .password-change-container {
        max-width: 600px;
        margin: 0 auto;
      }

      /* Password input styling to work with Req_leave.css */
      .password-input-container {
        position: relative;
        width: 100%;
      }

      .password-input-container input[type="password"],
      .password-input-container input[type="text"] {
        width: 100%;
        padding: 15px 50px 15px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        background-color: #f5f6fa;
        color: #2c3e50;
        font-size: 15px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .password-input-container input[type="password"]:focus,
      .password-input-container input[type="text"]:focus {
        outline: none;
        border-color: #c7ecee;
        background-color: #fff;
      }

      .password-toggle {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        font-size: 16px;
        border-radius: 5px;
        transition: background-color 0.3s ease;
        z-index: 2;
      }

      .password-toggle:hover {
        background-color: rgba(0, 0, 0, 0.1);
      }

      .password-requirements {
        margin-top: 8px;
      }

      .password-requirements small {
        color: #666;
        font-size: 12px;
        font-style: italic;
      }

      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2c3e50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .submit-btn:disabled {
        background-color: #ccc !important;
        cursor: not-allowed;
        opacity: 0.7;
      }

      .submit-btn:disabled:hover {
        background-color: #ccc !important;
        transform: none;
      }

      .security-tips {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .security-tips h3 {
        color: #2c3e50;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 500;
        text-transform: uppercase;
      }

      .security-tips ul {
        margin: 0;
        padding-left: 20px;
        color: #555;
      }

      .security-tips li {
        margin-bottom: 8px;
        font-size: 14px;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .password-change-container {
          padding: 0 15px;
        }
      }
    </style>
  </body>
</html>
